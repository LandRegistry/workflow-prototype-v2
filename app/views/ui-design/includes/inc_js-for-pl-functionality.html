<script>
    document.addEventListener('DOMContentLoaded', function() {

      const hmlrListTbl = document.getElementById('hmlrListTbl');
      
      if (hmlrListTbl) {// only run this code if 'hmlrListTbl' is present on this pg
  
        hmlrListTbl.classList.remove('hmlr-hide-my-notes');/* stops JS loading glitches */

        /*** record adjusted heights functionality, starts ***/
        var textareas = hmlrListTbl.querySelectorAll('.govuk-textarea');//or, all textareas inside .hmlr-my-notes-textarea 
  
        /*var isContentChanged = false; 
        function handleContentChange() {
          isContentChanged = true;
        }
        window.addEventListener('beforeunload', function(event) {
          if (isContentChanged) {
            var message = 'You have unsaved changes to "Show my notes". Are you sure you want to leave?';
            event.returnValue = message; // Standard for most browsers
            return message; // For some older browsers
          }
        });*/       
  
                  // Function to record the height and store it in localStorage
                  function recordHeight(textarea) {
                    var height = textarea.offsetHeight;
                    if (height != 0) {
                      textarea.style.height = height + 'px';
                      localStorage.setItem('textarea-' + textarea.id + '-height', height);
                    }
                  }
  
                  // Create a ResizeObserver to observe changes in size
                  var resizeObserver = new ResizeObserver(function(entries) {
                    entries.forEach(function(entry) {
                      if (entry.target instanceof HTMLTextAreaElement) {
                        recordHeight(entry.target);
                      }
                    });
                  });
  
        // Observe each textarea for resizing and apply stored height on page load
        textareas.forEach(function(textarea) {
  
          var myTd = textarea.closest('td');
                  
                  if (localStorage.getItem(textarea.id) === 'false') {//is NOT hidden, so show on pg reload
                    var mySpan = myTd.querySelector('.hmlr-my-notes');
                    mySpan.querySelector('span:first-child').textContent = 'Hide my notes';
                    myTd.querySelector('.hmlr-my-notes-textarea').classList.remove('hmlr-my-notes-textarea--hide');
                  }

                  if (textarea.value.trim() !== "") {//textarea is not empty
                    var myLink = myTd.querySelector('.hmlr-my-notes');
                    myLink.classList.add('hmlr-my-notes--added');//add dot icon to my notes link
                    myLink.setAttribute('aria-label', 'This case has notes');
                  }              
  
          // Apply stored height from localStorage when the page loads
          var storedHeight = localStorage.getItem('textarea-' + textarea.id + '-height');
          if (storedHeight) {
            textarea.style.height = storedHeight + 'px';
          }
          
          // Observe the textarea for resizing
          resizeObserver.observe(textarea); 
  
          // Add event listener for content changes
          //textarea.addEventListener('input', handleContentChange);        
        });
  
        /*** record adjusted heights functionality, ends ***/
        
        
  

          /* *** show/hide links for multi applications STARTS *** */
          hmlrListTbl.querySelectorAll('.hmlr-wf-lists__attached + .hmlr-wf-lists__attached').forEach(tbod => {
              tbod.setAttribute('aria-hidden', 'true');//only when there is JS are these case hidden
          });

          function toggleNextTbodyWithClass(currentTbody, className) {//targets "groups" of adjacent tbody elements
              let nextTbody = currentTbody.nextElementSibling;
              while (nextTbody) {
                  if (nextTbody.tagName.toLowerCase() === 'tbody' && nextTbody.classList.contains(className)) {
                      nextTbody.classList.toggle(className+'-show');
                      nextTbody.setAttribute('aria-hidden', nextTbody.getAttribute('aria-hidden') === 'false' ? 'true' : 'false');
                      nextTbody = nextTbody.nextElementSibling;
                  } else {
                      break; // Stop when next tbody doesn't have the class
                  }
              }
          }

          var attachedApps = hmlrListTbl.querySelectorAll('.hmlr-wf-lists__attached-link');  
          attachedApps.forEach(function(attachedApp) {
              
              attachedApp.addEventListener('click', function(e) {
                  e.preventDefault();  
                  toggleNextTbodyWithClass(attachedApp.closest('tbody'), 'hmlr-wf-lists__attached');
                  
                  const firstSpan = attachedApp.querySelector('span:first-child');
                  if (firstSpan.textContent.trim() === 'Show attached applications') {
                      firstSpan.textContent = 'Hide attached applications';
                      localStorage.setItem(attachedApp.id, 'false');//is NOT hidden
                  } else {
                      firstSpan.textContent = 'Show attached applications';
                      localStorage.setItem(attachedApp.id, 'true');//is hidden
                  }

              });

              if (localStorage.getItem(attachedApp.id) === 'false') {//is NOT hidden, so show on pg reload
                attachedApp.querySelector('span:first-child').textContent = 'Hide attached applications';
                toggleNextTbodyWithClass(attachedApp.closest('tbody'), 'hmlr-wf-lists__attached');
              }

          });
          /* *** show/hide links for multi applications ENDS *** */

        
        /*** my notes show/hide functionality starts ***/
        hmlrListTbl.querySelectorAll('.hmlr-my-notes-textarea').forEach(txtarea => {
          txtarea.setAttribute('aria-hidden', 'true');//are hidden only when JS is supported

          //make button green if textarea content changes
          const thisTxtArea = txtarea.querySelector('.govuk-textarea');
          const thisBtn = txtarea.querySelector('.govuk-button');
          if (thisTxtArea && thisBtn) {
            const removeClassOnce = () => {
              thisBtn.classList.remove('govuk-button--secondary');
                thisTxtArea.removeEventListener('input', removeClassOnce);
              };
              thisTxtArea.addEventListener('input', removeClassOnce);
            }
          });


        const noteLinks = hmlrListTbl.querySelectorAll('.hmlr-my-notes');//find ea link
        
        noteLinks.forEach(function(noteLink) {
          noteLink.addEventListener('click', function(e) {
              e.preventDefault();
              const parentTd = noteLink.closest('td');
              const textareaDiv = parentTd.querySelector('.hmlr-my-notes-textarea');
              textareaDiv.classList.toggle('hmlr-my-notes-textarea--hide'); 
              textareaDiv.setAttribute('aria-hidden', textareaDiv.getAttribute('aria-hidden') === 'false' ? 'true' : 'false');

              const theSpan = noteLink.querySelector('span:first-child');
              if (theSpan.textContent.trim() === 'Show my notes') {
                theSpan.textContent = 'Hide my notes';
              } else {
                theSpan.textContent = 'Show my notes';
              }
  
              const textarea = parentTd.querySelector('textarea');//set storage val to maintain show/hide state on pg reload
              if (textareaDiv.classList.contains('hmlr-my-notes-textarea--hide')) {
                localStorage.setItem(textarea.id, 'true');//is hidden
              } else {
                localStorage.setItem(textarea.id, 'false');//is NOT hidden
              }
  
            });
        });
        /*** my notes show/hide functionality ends ***/
  
  
  
        /*** add/remove flags starts ***/
          /*function checkIfTblsExist() {
            const tbl1 = document.getElementById(progress_now_table);
            const tbl2 = document.getElementById(progress_later_table);
            if (tbl1 || tbl2) {
                return true;
            } else {
                return false;
            }
          }
          //if (checkIfTblsExist) {//only run code if we're on the right page!*/
  
            const mainContent2 = document.getElementById('main-content');
            const links = mainContent2.querySelectorAll('.hmlr-flag-icon-btn');
            
            links.forEach(link => {//loop through each link and add a click event 
              link.addEventListener('click', function(e) {
                e.preventDefault(); 
                const svgElement = this.nextElementSibling;// Find the sibling svg element
  
                svgElement.classList.toggle('hmlr-flag-icon-show');
                svgElement.setAttribute('aria-hidden', svgElement.getAttribute('aria-hidden') === 'false' ? 'true' : 'false');
  
                this.value = this.value.trim() === 'Remove flag' ? 'Add flag' : 'Remove flag';//toggle input/button text
                //this.textContent = this.textContent.trim() === 'Remove flag' ? 'Add flag' : 'Remove flag';//toggle link text
                this.blur();//remove focus
              });
            });
      
          //}
        /*** add/remove flags ends ***/

        /*** style last of each block of multi title cases/rows STARTS ***/
        const tbodies = hmlrListTbl.querySelectorAll('.hmlr-wf-lists__attached');//find ea instance
        let currentBlock = [];
        tbodies.forEach((tbody, index) => {
          currentBlock.push(tbody);

          // Check if the next tbody is part of a new block or if it's the last tbody
          if (!tbodies[index + 1] || !tbodies[index + 1].classList.contains("hmlr-wf-lists__attached")) {
            // Add the class to the last tbody in the current block
            currentBlock[currentBlock.length - 1].classList.add("hmlr-wf-lists__attached--last");
            // Reset the current block
            currentBlock = [];
          }
        });
        /*** style last of each block of multi title cases/rows ENDS ***/
  
  
  
  
   
  
        /*** record adjusted heights functionality, starts ***/
        /*var textareas = hmlrListTbl.querySelectorAll('.govuk-textarea');
  
        // record height in localStorage
        function recordHeight(textarea, index) {
          var height = textarea.offsetHeight;
          if (height != 0) {
            textarea.style.height = height + 'px';
            localStorage.setItem('textarea-' + index + '-height', height);
          }
        }
  
        // observe changes in textarea size when users pull drag bars
        var resizeObserver = new ResizeObserver(function(entries) {
          entries.forEach(function(entry) {
            if (entry.target instanceof HTMLTextAreaElement) {
              var index = Array.from(textareas).indexOf(entry.target);
              recordHeight(entry.target, index);
            }
          });
        });
  
        // apply stored height when page is loaded
        textareas.forEach(function(textarea, index) {
          var storedHeight = localStorage.getItem('textarea-' + index + '-height');
          if (storedHeight) {
            textarea.style.height = storedHeight + 'px';
          }
          
          // observe textarea resizing
          resizeObserver.observe(textarea);
        });*/
  
        
  
        /*** record adjusted heights functionality, ends ***/
  
  
  
  
  
  
        function isFirstDayOfSpecificMonthsAndTime() {
            var today = new Date();
            var months = [3, 7, 11]; // Apr, Aug, Dec (from zero)
            var isCorrectDay = false;
            var isCorrectTime = false;
            if(months.includes(today.getMonth())){
              isCorrectDay = today.getDate() === 1;
              isCorrectTime = (today.getHours() === 10 && today.getMinutes() < 45);          
            }
            return isCorrectDay && isCorrectTime;
        }
        if (isFirstDayOfSpecificMonthsAndTime()) {
            //occasionally clear old local storage (used for UI displays per ea case); on this domain
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('textarea-my-notes-')) {//textarea height
                    localStorage.removeItem(key);
                }
                if (key.startsWith('my-notes-')) {//my-notes show/hide  
                    localStorage.removeItem(key);
                }  
                if (key.startsWith('attached-')) {//attached cases show/hide 
                    localStorage.removeItem(key);
                }       
            }          
        }//localStorage.clear(); //Use .clear when developing
        
  
      }



//localStorage.clear(); 
    });    
  </script>